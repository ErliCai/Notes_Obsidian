[是微服务架构不香还是云不香](https://coolshell.cn/articles/22422.html)

[Scaling up the Prime Video audio/video monitoring service and reducing costs by 90%](https://www.primevideotech.com/video-streaming/scaling-up-the-prime-video-audio-video-monitoring-service-and-reducing-costs-by-90)

[Even Amazon can't make sense of serverless or microservices](https://world.hey.com/dhh/even-amazon-can-t-make-sense-of-serverless-or-microservices-59625580)

**从分布式微服务架构到单体应用程序的转变有助于实现更高的规模、弹性和降低成本**

![[Amazon Prime Vedio arch.png]]

#### service overview:
- **这个系统是一个监控系统，用于监控数据千条用户的点播视频流**。主要是监控整个视频流运作的质量和效果
- 一个微服务主要是用来把视频拆分成帧，并临时存在 S3 上
- 为了快速搭建系统，Prime Video团队使用了Serverless 架构，也就是著名的 AWS Lambda 和 AWS Step Functions
- 前置 Lambda 用来做用户请求的网关，Step Function 用来做监控（探测器），有问题后，就发 SNS 上，Step Function 从 S3 获取 Media Conversion 的数据，然后把运行结果再汇总给一个后置的 Lambda ，并存在 S3 上。


#### pro: 
使用了 Serverless 的架构, 方便快捷，完全不理那些无聊的基础设施，直接把代码转成服务，然后用 AWS 的 Lamda + Step Function + SNS + S3 分分钟就搭出一个有模有样的监控系统了

#### cons:
- 需要很多很多的并发的 AWS Step Function ，于是达到了帐户的 hard limit
- AWS Step Function 按状态转换收费，所以，贵得受不了了

#### 解决方法：
- 把 Media Conversion  和 Step Function 全部写在一个程序里，Media Conversion 跟 Step Function 里的东西通过内存通信，不再走S3了
- 把上面这个单体架构进行分布式部署，还是用之前的 AWS Lambda 来做入门调度

![[updated arch.png]]

#### 优点：
- EC2 的水平扩展没有限制，而且你想买多少 CPU/MEM 的机器由你说了算
- 不再受 Step Function 的限制了，技术在自己手里，有更大的自由度
- 没有昂贵的 Step Function 云成本的确变得更低了

#### thinking：
- **AWS 的 Serverless 也好， 微服务也好，单体也好，在合适的场景也都很香**
- **这篇文章中的这个例子中的业务太过简单了，本来就是一两个服务就可以干完的事**， 微服务划分的原则应该是：**边界上下文**，**单一职责，高内聚，低耦合**， **事务和一致性**，**跟组织架构匹配**
    **边界上下文**。微服务的粒度不能大于领域驱动里的 Bounded Context（具体是什么 大家自行 Google），也就是一个业务域。
    **单一职责，高内聚，低耦合**。把因为相同原因变化的合在一起（内聚），把不同原因变化的分开（解耦）
    **事务和一致性**。对于两个重度依赖的功能，需要完成一个事务和要保证强一致性的，最好不要拆开，要放在一起。
    **跟组织架构匹配**。把同一个团队的东西放在一起，不同团队的分开。
- **Prime Video 遇到的问题不是技术问题，而是 AWS  Step Function 处理能力不足，而且收费还很贵的问题**

